# 第 17.15 节 Zabbix 监控（基于 PostgreSQL）

## 安装 

### 安装 zabbix7-server

zabbix7-server 是服务器端。负责接收、处理监控数据，应运行在监控服务器上。
 
pkg 安装会安装多余的 MySQL，故使用 Ports 安装。

```
# cd /usr/ports/net-mgmt/zabbix7-server/ 
# make config
```

按如图配置，选中 `PGSQL` 后按回车键：


Ports 安装太慢，直接 pkg 补全缺失的依赖（国内镜像站可能会报错）：

```sh
# make install-missing-packages
```

编译 zabbix7-server：

```
# make install clean
```

### 安装 PostgreSQL

 zabbix7-server会自动安装 PostgreSQL 客户端。

查看版本：

```
root@ykla:/ # psql --version
psql (PostgreSQL) 16.8
```

安装：

```
# pkg install postgresql16-server
```

或

```
# cd /usr/ports/databases/postgresql16-server/ 
# make install clean
```

### 安装 zabbix7-frontend 

zabbix7-frontend 是 web 控制前端。

```
# pkg ins zabbix7-frontend-php84
```
上述安装过程会自动安装 PHP，本文中安装的版本是 PHP8.4，具体可用版本可以到 [zabbix7-frontend](https://www.freshports.org/net-mgmt/zabbix7-frontend) 看一下。

或者：

```
# cd /usr/ports/net-mgmt/zabbix7-frontend/ 
# make install clean
```

## 安装 zabbix7-agent

zabbix7-agent 负责数据采集，安装在被监控的服务器上。

```
# pkg install zabbix7-agent
```

或者

```
# cd /usr/ports/net-mgmt/zabbix7-agent/ 
# make install clean
```

## 安装 nginx

```
# pkg install nginx
```

```
# cd /usr/ports/www/nginx/ 
# make install clean
```

## 配置服务开机自启

```sh
# service zabbix_server enable
# service zabbix_agentd enable
# service postgresql enable
# service nginx enable
# service php_fpm enable
```

## 设置数据库

初始化数据库

```sql
# service postgresql initdb # 初始化数据库
# su - postgres # 切换到数据库用户
$ /usr/local/bin/pg_ctl -D /var/db/postgres/data16 -l logfile start # 初始化服务
$ cd /usr/local/share/zabbix7/server/database/postgresql/
$ psql -d template1 # 切换到此数据库
psql (16.8)
Type "help" for help.

template1=# create database zabbix; # 创建 zabbix 数据库
CREATE DATABASE
template1=# CREATE USER zabbix WITH PASSWORD 'z'; # 此处设置用户 zabbix 密码为 z
CREATE ROLE
template1'# GRANT ALL PRIVILEGES ON DATABASE zabbix TO zabbix; # 在授予用户 zabbix 对 zabbix 数据库有所有权限
GRANT
template1'# exit # 退出

```

```sql
$ cd /usr/local/share/zabbix7/server/database/postgresql/
$  psql -d zabbix
psql (16.8)
Type "help" for help.

zabbix=# \i schema.sql
CREATE TABLE
CREATE INDEX
CREATE TABLE
CREATE INDEX
CREATE TABLE
……省略……

zabbix=# \i images.sql
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
……省略……

zabbix=# \i data.sql
START TRANSACTION
INSERT 0 4
INSERT 0 1
INSERT 0 2
……省略……
zabbix=# \q # 退出
$
```

## 设置 Zabbix

Zabbix 的主要配置文件位于 `/usr/local/etc/zabbix7/zabbix_server.conf`。

```ini
SourceIP=127.0.0.1
LogFile=/var/log/zabbix/zabbix_server.log
DBHost=
DBName=zabbix
DBUser=zabbix
DBPassword=z
Timeout=4
LogSlowQueries=3000
StatsAllowedIP=127.0.0.1
```

## 设置 Zabbix Agent

Zabbix Agent 配置文件位于 `/usr/local/etc/zabbix7/zabbix_agentd.conf`

```ini
LogFile=/var/log/zabbix/zabbix_agentd.log
SourceIP=127.0.0.1
Server=127.0.0.1
ServerActive=127.0.0.1
```

## 配置 Zabbix 前端

Zabbix 前端配置文件模板位于 `/usr/local/www/zabbix7/conf/zabbix.conf.php.example`。

```sh
# cp /usr/local/www/zabbix7/conf/zabbix.conf.php.example /usr/local/www/zabbix7/conf/zabbix.conf.php
```

将

```ini
$DB['TYPE']                             = 'MYSQL';
$DB['SERVER']                   = 'localhost';
$DB['PORT']                             = '0';
$DB['DATABASE']                 = 'zabbix';
$DB['USER']                             = 'zabbix';
$DB['PASSWORD']                 = '';
```

修改如下：

```ini
$DB['TYPE']                             = 'POSTGRESQL'; #数据库改成这个
$DB['SERVER']                   = 'localhost';
$DB['PORT']                             = '0';
$DB['DATABASE']                 = 'zabbix';
$DB['USER']                             = 'zabbix';
$DB['PASSWORD']                 = 'z';  # 这里是你的密码
``

### 配置 nginx

编辑 `/usr/local/etc/nginx/nginx.conf`，

```ini
worker_processes 1;
events {
  worker_connections 1024;
}
http {
  include             mime.types;
  default_type        application/octet-stream;
  sendfile            on;
  keepalive_timeout   65;
  server {
    listen            80;
    server_name       localhost;
    root /usr/local/www/zabbix7;
    index index.php index.html index.htm;
    location / {
      try_files $uri $uri/ =404;
    }
    location ~ .php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
      fastcgi_param REMOTE_USER $remote_user;
      fastcgi_pass unix:/var/run/php-fpm.sock;
      fastcgi_index index.php;
      include fastcgi_params;
    }

}}
```


